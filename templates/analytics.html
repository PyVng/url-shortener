{% extends "base.html" %}

{% block title %}Аналитика - {{ short_code }} - URL Shortener{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto px-4 py-8">
    <!-- Header -->
    <div class="mb-8">
        <div class="flex items-center justify-between mb-4">
            <div>
                <h1 class="text-3xl font-bold text-text-primary mb-2">Аналитика ссылки</h1>
                <div class="flex items-center gap-4">
                    <span class="text-lg font-mono bg-gray-100 px-3 py-1 rounded">{{ short_code }}</span>
                    <a href="/{{ short_code }}" target="_blank" class="text-primary hover:text-primary-hover underline">
                        Перейти к ссылке →
                    </a>
                </div>
            </div>
            <a href="/info/{{ short_code }}" class="bg-gray-100 text-text-primary px-4 py-2 rounded-md hover:bg-gray-200 transition-colors">
                ← Назад к информации
            </a>
        </div>
    </div>

    <!-- URL Info Card -->
    <div id="urlInfoCard" class="glass rounded-xl p-6 mb-8">
        <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-primary mx-auto"></div>
        <p class="text-center text-text-muted mt-4">Загрузка информации о ссылке...</p>
    </div>

    <!-- Analytics Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
        <!-- Clicks Over Time Chart -->
        <div class="glass rounded-xl p-6">
            <h3 class="text-xl font-semibold text-text-primary mb-4">Клики по времени</h3>
            <div id="clicksChart" class="h-64 flex items-center justify-center">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
                <span class="ml-3 text-text-muted">Загрузка графика...</span>
            </div>
        </div>

        <!-- Device Types Chart -->
        <div class="glass rounded-xl p-6">
            <h3 class="text-xl font-semibold text-text-primary mb-4">Устройства</h3>
            <div id="devicesChart" class="h-64 flex items-center justify-center">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
                <span class="ml-3 text-text-muted">Загрузка данных...</span>
            </div>
        </div>

        <!-- Countries Chart -->
        <div class="glass rounded-xl p-6">
            <h3 class="text-xl font-semibold text-text-primary mb-4">География</h3>
            <div id="countriesChart" class="h-64 flex items-center justify-center">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
                <span class="ml-3 text-text-muted">Загрузка данных...</span>
            </div>
        </div>

        <!-- Referrers Chart -->
        <div class="glass rounded-xl p-6">
            <h3 class="text-xl font-semibold text-text-primary mb-4">Источники трафика</h3>
            <div id="referrersChart" class="h-64 flex items-center justify-center">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
                <span class="ml-3 text-text-muted">Загрузка данных...</span>
            </div>
        </div>
    </div>

    <!-- Detailed Stats Table -->
    <div class="glass rounded-xl p-6">
        <h3 class="text-xl font-semibold text-text-primary mb-4">Детальная статистика</h3>

        <div id="statsTable" class="overflow-x-auto">
            <table class="w-full">
                <thead>
                    <tr class="border-b border-gray-200">
                        <th class="text-left py-3 px-4 font-medium text-text-primary">Дата</th>
                        <th class="text-left py-3 px-4 font-medium text-text-primary">Время</th>
                        <th class="text-left py-3 px-4 font-medium text-text-primary">IP</th>
                        <th class="text-left py-3 px-4 font-medium text-text-primary">Страна</th>
                        <th class="text-left py-3 px-4 font-medium text-text-primary">Устройство</th>
                        <th class="text-left py-3 px-4 font-medium text-text-primary">Браузер</th>
                        <th class="text-left py-3 px-4 font-medium text-text-primary">Источник</th>
                        <th class="text-left py-3 px-4 font-medium text-text-primary">Целевой URL</th>
                    </tr>
                </thead>
                <tbody id="statsTableBody">
                    <tr>
                        <td colspan="8" class="text-center py-8 text-text-muted">
                            <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-primary mx-auto mb-2"></div>
                            Загрузка статистики...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <div id="pagination" class="flex justify-center mt-6 hidden">
            <button id="prevPage" class="px-4 py-2 bg-gray-100 text-text-primary rounded-l-md hover:bg-gray-200 disabled:opacity-50 disabled:cursor-not-allowed">← Предыдущая</button>
            <span id="pageInfo" class="px-4 py-2 bg-gray-50 text-text-primary border-x border-gray-200">Страница 1</span>
            <button id="nextPage" class="px-4 py-2 bg-gray-100 text-text-primary rounded-r-md hover:bg-gray-200 disabled:opacity-50 disabled:cursor-not-allowed">Следующая →</button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
class AnalyticsDashboard {
    constructor(shortCode) {
        this.shortCode = shortCode;
        this.currentPage = 1;
        this.pageSize = 50;
        this.charts = {};
        this.init();
    }

    init() {
        this.loadUrlInfo();
        this.loadAnalytics();
        this.setupPagination();
    }

    async loadUrlInfo() {
        try {
            const response = await fetch(`/api/info/${this.shortCode}`);
            if (response.ok) {
                const data = await response.json();

                document.getElementById('urlInfoCard').innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="text-center">
                            <div class="text-3xl font-bold text-primary mb-2">${data.data.click_count}</div>
                            <div class="text-text-muted">Всего кликов</div>
                        </div>
                        <div class="text-center">
                            <div class="text-lg font-mono bg-gray-100 px-3 py-1 rounded mb-2">${data.data.short_code}</div>
                            <div class="text-text-muted">Короткий код</div>
                        </div>
                        <div class="text-center">
                            <div class="text-sm text-text-muted mb-2">${new Date(data.data.created_at).toLocaleDateString('ru-RU')}</div>
                            <div class="text-text-muted">Дата создания</div>
                        </div>
                    </div>
                    <div class="mt-4 pt-4 border-t border-gray-200">
                        <div class="text-sm text-text-muted mb-1">Оригинальный URL:</div>
                        <div class="font-mono text-sm bg-gray-50 p-3 rounded break-all">${data.data.original_url}</div>
                    </div>
                `;
            } else {
                document.getElementById('urlInfoCard').innerHTML = `
                    <div class="text-center text-red-600 py-8">
                        <p>Ошибка загрузки информации о ссылке</p>
                    </div>
                `;
            }
        } catch (error) {
            console.error('Error loading URL info:', error);
            document.getElementById('urlInfoCard').innerHTML = `
                <div class="text-center text-red-600 py-8">
                    <p>Ошибка загрузки информации о ссылке</p>
                </div>
            `;
        }
    }

    async loadAnalytics() {
        try {
            // For now, show placeholder data since we don't have real analytics API yet
            this.renderCharts(this.getMockData());
            this.renderStatsTable(this.getMockStats());
        } catch (error) {
            console.error('Error loading analytics:', error);
            this.showErrorState();
        }
    }

    getMockData() {
        return {
            clicksOverTime: {
                labels: ['2025-01-01', '2025-01-02', '2025-01-03', '2025-01-04', '2025-01-05', '2025-01-06', '2025-01-07'],
                data: [12, 19, 3, 5, 2, 3, 9]
            },
            devices: {
                desktop: 65,
                mobile: 25,
                tablet: 10
            },
            countries: {
                'RU': 45,
                'US': 20,
                'DE': 15,
                'FR': 10,
                'Other': 10
            },
            referrers: {
                'google.com': 40,
                'direct': 25,
                'facebook.com': 15,
                'twitter.com': 10,
                'other': 10
            }
        };
    }

    getMockStats() {
        return [
            {
                date: '2025-01-07',
                time: '14:30:25',
                ip: '192.168.1.1',
                country: 'RU',
                device: 'desktop',
                browser: 'Chrome',
                referrer: 'google.com',
                target_url: 'https://example.com/page1'
            },
            {
                date: '2025-01-07',
                time: '13:15:10',
                ip: '10.0.0.1',
                country: 'US',
                device: 'mobile',
                browser: 'Safari',
                referrer: 'direct',
                target_url: 'https://example.com/page1'
            },
            {
                date: '2025-01-06',
                time: '16:45:33',
                ip: '172.16.0.1',
                country: 'DE',
                device: 'tablet',
                browser: 'Firefox',
                referrer: 'facebook.com',
                target_url: 'https://example.com/page2'
            }
        ];
    }

    renderCharts(data) {
        // Clicks over time chart
        const clicksCtx = document.getElementById('clicksChart').getContext('2d');
        this.charts.clicks = new Chart(clicksCtx, {
            type: 'line',
            data: {
                labels: data.clicksOverTime.labels,
                datasets: [{
                    label: 'Клики',
                    data: data.clicksOverTime.data,
                    borderColor: '#007aff',
                    backgroundColor: 'rgba(0, 122, 255, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });

        // Devices pie chart
        const devicesCtx = document.getElementById('devicesChart').getContext('2d');
        this.charts.devices = new Chart(devicesCtx, {
            type: 'doughnut',
            data: {
                labels: ['Desktop', 'Mobile', 'Tablet'],
                datasets: [{
                    data: [data.devices.desktop, data.devices.mobile, data.devices.tablet],
                    backgroundColor: ['#007aff', '#28a745', '#ffc107'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom' }
                }
            }
        });

        // Countries bar chart
        const countriesCtx = document.getElementById('countriesChart').getContext('2d');
        this.charts.countries = new Chart(countriesCtx, {
            type: 'bar',
            data: {
                labels: Object.keys(data.countries),
                datasets: [{
                    label: 'Посещения',
                    data: Object.values(data.countries),
                    backgroundColor: '#007aff',
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });

        // Referrers bar chart
        const referrersCtx = document.getElementById('referrersChart').getContext('2d');
        this.charts.referrers = new Chart(referrersCtx, {
            type: 'bar',
            data: {
                labels: Object.keys(data.referrers),
                datasets: [{
                    label: 'Посещения',
                    data: Object.values(data.referrers),
                    backgroundColor: '#28a745',
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
    }

    renderStatsTable(stats) {
        const tbody = document.getElementById('statsTableBody');

        if (!stats || stats.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center py-8 text-text-muted">
                        Нет данных для отображения
                    </td>
                </tr>
            `;
            return;
        }

        tbody.innerHTML = stats.map(stat => `
            <tr class="border-b border-gray-100 hover:bg-gray-50">
                <td class="py-3 px-4">${stat.date}</td>
                <td class="py-3 px-4">${stat.time}</td>
                <td class="py-3 px-4 font-mono text-sm">${stat.ip}</td>
                <td class="py-3 px-4">
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                        ${stat.country}
                    </span>
                </td>
                <td class="py-3 px-4">
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${
                        stat.device === 'mobile' ? 'bg-green-100 text-green-800' :
                        stat.device === 'tablet' ? 'bg-yellow-100 text-yellow-800' :
                        'bg-gray-100 text-gray-800'
                    }">
                        ${stat.device}
                    </span>
                </td>
                <td class="py-3 px-4">${stat.browser}</td>
                <td class="py-3 px-4">
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
                        ${stat.referrer}
                    </span>
                </td>
                <td class="py-3 px-4">
                    <div class="font-mono text-sm max-w-xs truncate" title="${stat.target_url}">
                        ${stat.target_url}
                    </div>
                </td>
            </tr>
        `).join('');

        // Show pagination if we have data
        if (stats.length > 0) {
            document.getElementById('pagination').classList.remove('hidden');
        }
    }

    setupPagination() {
        document.getElementById('prevPage').addEventListener('click', () => {
            if (this.currentPage > 1) {
                this.currentPage--;
                this.updatePagination();
                this.loadAnalytics(); // Reload data for new page
            }
        });

        document.getElementById('nextPage').addEventListener('click', () => {
            this.currentPage++;
            this.updatePagination();
            this.loadAnalytics(); // Reload data for new page
        });

        this.updatePagination();
    }

    updatePagination() {
        document.getElementById('pageInfo').textContent = `Страница ${this.currentPage}`;

        const prevBtn = document.getElementById('prevPage');
        const nextBtn = document.getElementById('nextPage');

        prevBtn.disabled = this.currentPage <= 1;
        // For demo, assume we have more pages
        nextBtn.disabled = false;
    }

    showErrorState() {
        ['clicksChart', 'devicesChart', 'countriesChart', 'referrersChart'].forEach(chartId => {
            document.getElementById(chartId).innerHTML = `
                <div class="text-center text-red-600">
                    <p>Ошибка загрузки данных</p>
                </div>
            `;
        });

        document.getElementById('statsTableBody').innerHTML = `
            <tr>
                <td colspan="8" class="text-center py-8 text-red-600">
                    Ошибка загрузки статистики
                </td>
            </tr>
        `;
    }
}

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
    const shortCode = '{{ short_code }}';
    new AnalyticsDashboard(shortCode);
});
</script>
{% endblock %}
